<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글로벌탑넷 - 기사 자동화</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
            padding-top: 10%;
        }
        .center {
            text-align: center;
        }
        .keywords {
            margin-top: 20px;
        }
        .keyword-list {
            margin-top: 10px;
            list-style-type: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .keyword-item {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px 10px;
        }
        .keyword-item span {
            margin-right: 10px;
        }
        .keyword-item button {
            color: black;
            border: none;
            width: 20px;
            height: 20px;
            display: flex;
            cursor: pointer;
        }
        .article-list {
            margin-top: 20px;
            list-style-type: none;
            padding: 0;
        }
        .article-item {
            margin-bottom: 10px;
        }
        .article-item a {
            text-decoration: none;
            color: blue;
        }
        .loading-bar {
            display: none;
            width: 50px;
            height: 50px;
            border: 6px solid #ccc;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .section-header {
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="loading-bar" id="loadingBar"></div>
    <div class="center">
        <label for="regionSelect">지역 선택:</label>
        <select id="regionSelect" name="regionSelect">
            <option value="all" selected>전체</option>
            <option value="seoul">서울</option>
            <option value="busan">부산</option>
        </select>
        <br><br>
        <div class="keywords">
            <label for="keywordInput">키워드 입력:</label>
            <input type="text" id="keywordInput" name="keywordInput">
            <button onclick="saveKeyword()">저장</button>
            <ul id="keywordList" class="keyword-list"></ul>
            <button id="fetchArticlesButton" onclick="fetchArticles()">기사들 가져오기</button>
        </div>
        <p id="status"></p>
        <ul id="articleList" class="article-list"></ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    <script>
        const keywords = [];

        document.getElementById('keywordInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveKeyword();
            }
        });

        function saveKeyword() {
            const keywordInput = document.getElementById('keywordInput');
            const keyword = keywordInput.value.trim();
            if (keyword && !keywords.includes(keyword)) {
                keywords.push(keyword);
                updateKeywordList();
                keywordInput.value = '';
            }
        }

        function updateKeywordList() {
            const keywordList = document.getElementById('keywordList');
            keywordList.innerHTML = '';
            keywords.forEach((keyword, index) => {
                const li = document.createElement('li');
                li.className = 'keyword-item';
                li.innerHTML = `<span>${keyword}</span><button onclick="removeKeyword(${index})">×</button>`;
                keywordList.appendChild(li);
            });
        }

        function removeKeyword(index) {
            keywords.splice(index, 1);
            updateKeywordList();
        }

        async function fetchArticles() {
            const region = document.getElementById('regionSelect').value;
            const status = document.getElementById('status');
            const articleList = document.getElementById('articleList');
            articleList.innerHTML = '';
            status.textContent = 'Fetching articles...';

            let seoulArticles = [];
            let busanArticles = [];

            if (region === 'seoul' || region === 'all') {
                seoulArticles = await getArticles('seoul');
            }

            if (region === 'busan' || region === 'all') {
                busanArticles = await getArticles('busan');
            }

            if (region === 'all') {
                displayArticles('서울특별시 소식 보도자료:', seoulArticles);
                displayArticles('부산광역시 소식 보도자료:', busanArticles);
            } else {
                const articles = region === 'seoul' ? seoulArticles : busanArticles;
                displayArticles('', articles);
            }

            status.textContent = '';
        }

        async function getArticles(region) {
            const rssUrl = region === 'seoul' 
                ? 'https://seoulboard.seoul.go.kr/rss/RSSGenerator?bbsNo=158' 
                : 'https://www.busan.go.kr/nbtnewsBU.rss';
            const pdfBaseUrl = region === 'seoul' 
                ? 'https://seoulboard.seoul.go.kr/comm/getFile?srvcId=BBSTY1&upperNo=' 
                : 'https://www.busan.go.kr/comm/getFile?srvcId=BBSTY3&upperNo=';

            try {
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(rssUrl));
                const data = await response.json();
                let text;

                if (region === 'busan') {
                    text = decodeBase64(data.contents.split(',')[1]); // Base64 decoding
                } else {
                    text = data.contents;
                }

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "application/xml");

                const items = xmlDoc.getElementsByTagName('item');
                const filteredArticles = [];

                for (let item of items) {
                    const title = item.getElementsByTagName('title')[0].textContent;
                    const link = item.getElementsByTagName('link')[0].textContent;
                    const upperNo = link.split('/').pop(); // Extract upperNo from the link

                    let newLink;
                    if (region === 'seoul') {
                        newLink = `${pdfBaseUrl}${upperNo}&fileTy=ATTACH&fileNo=2&bbsNo=158`;
                    } else {
                        newLink = `${pdfBaseUrl}${upperNo}&fileTy=ATTACH&fileNo=1`;
                    }

                    if (keywords.length === 0 || keywords.some(keyword => title.toLowerCase().includes(keyword.toLowerCase()))) {
                        filteredArticles.push({ title, newLink });
                    }
                }

                return filteredArticles;
            } catch (error) {
                console.error(`Error fetching articles from ${region}:`, error);
                return [];
            }
        }

        function displayArticles(header, articles) {
            const articleList = document.getElementById('articleList');
            if (header) {
                const headerElement = document.createElement('li');
                headerElement.textContent = header;
                headerElement.className = 'section-header';
                articleList.appendChild(headerElement);
            }
            if (articles.length > 0) {
                articles.forEach(article => {
                    const li = document.createElement('li');
                    li.className = 'article-item';
                    li.innerHTML = `<a href="javascript:void(0);" onclick="handleArticleClick('${article.newLink}', '${article.title}', '${article.region}')">${article.title}</a>`;
                    articleList.appendChild(li);
                });
            } else {
                const noArticlesElement = document.createElement('li');
                noArticlesElement.textContent = '키워드와 맞는 기사가 현재 없습니다';
                noArticlesElement.className = 'article-item';
                articleList.appendChild(noArticlesElement);
            }
        }

        function decodeBase64(str) {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        function handleArticleClick(link, title, region) {
            const loadingBar = document.getElementById('loadingBar');
            loadingBar.style.display = 'block';

            fetch(`/download?url=${encodeURIComponent(link)}&title=${encodeURIComponent(title)}&region=${encodeURIComponent(region)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = `/summarize?filename=${encodeURIComponent(data.filename)}&title=${encodeURIComponent(title)}`;
                    } else {
                        loadingBar.style.display = 'none';
                        alert('Failed to download the article.');
                    }
                })
                .catch(error => {
                    loadingBar.style.display = 'none';
                    console.error('Error downloading the article:', error);
                    alert('Failed to download the article.');
                });
        }
    </script>
</body>
</html>
